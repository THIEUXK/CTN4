@{
    ViewData["Title"] = "Index";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";

}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Date Range</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
</head>

<div class="row">
    <div class="container" style=" margin-top:100px">
        <div class="row">
            <div class="col-md-6">
                <label for="startDate">Start Date:</label>
                <input type="date" id="startDate" name="startDate" class="form-control datepicker">
            </div>
            <div class="col-md-6">
                <label for="endDate">End Date:</label>
                <input type="date" id="endDate" name="endDate" class="form-control datepicker">
            </div>
            <button type="submit" id="dataDate"> Thống kê</button>
        </div>
    </div>



        <div class="row mt-4">
            <div class="col-md-6">
                <h3>Đơn hàng</h3>
                <canvas id="myChartj"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-5" style="margin-top:200px">
        <h3>Tổng doanh thu trong năm</h3>
        <canvas id="myCharts"></canvas>
    </div>
    <div class="col-md-5" style="margin-top:200px">
        <h3>Tổng đơn hàng trong năm</h3>
        <canvas id="myChartss"></canvas>
    </div>

    <div class="col-md-5" style="margin-top:200px">
        <h3>Tổng hóa đơn lịch sử</h3>
        <canvas id="myChart"></canvas>
    </div>
    <div id="bestSellingProductsContainer"></div> 

</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>

    $(document).ready(function () {
        // Thống kê Hóa Đơn

        $('#dataDate').click(function () {
            dataDate();
        });
        function drawChart(chartId, label, dataUrl) {
            $.ajax({
                url: dataUrl,   
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    console.log(data);
                    const ctx = document.getElementById(chartId);
                    const myChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'],
                            datasets: [{
                                label: label,
                                data: data,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                },
                error: function (error) {
                    console.error('Đã xảy ra lỗi:', error);
                }
            });
        }

        // Thống kê Hóa Đơn
        drawChart('myChart', 'Hóa Đơn', '/Admin/Home/thongke');

        // Thống kê Tổng tiền
        drawChart('myCharts', 'Tổng tiền', '/Admin/Home/thongkeHd');

        // Thống kê Hóa Đơn (phương thức khác)
        drawChart('myChartss', 'Hóa Đơn', '/Admin/Home/thongke');

      //  drawChart('myChartss', 'Hóa Đơn', '/Admin/Home/thongke');

        // Thống kê sản phẩm bán chạy nhất
        $.ajax({
            url: "/Admin/Home/GetBestSellingProducts",
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                var container = $('#bestSellingProductsContainer');
                container.empty();

                for (var i = 0; i < data.length; i++) {
                    var product = data[i];
                    var productHtml = '<div>';
                    productHtml += '<p>Product ID: ' + product.productId + '</p>';
                    productHtml += '<p>Product Name: ' + product.productName + '</p>';
                    productHtml += '<p>Total Quantity Sold: ' + product.totalQuantitySold + '</p>';
                    productHtml += '</div>';
                    container.append(productHtml);
                }
            },
            error: function (error) {
                console.error('Error:', error);
            }
        });
        function dataDate() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');

            // Check if both start date and end date are selected
            if (!startDateInput.value || !endDateInput.value) {
                alert("Please select both start and end dates.");
                return;
            }

            // Calculate the number of days in the selected date range
            const numberOfDays = calculateNumberOfDays(startDateInput.value, endDateInput.value);

            // Check if the number of days is more than 31
            if (numberOfDays > 31) {
                alert("Please select a date range within one month.");
                return;
            }

            $.ajax({
                type: "POST",
                url: "/Admin/Home/thongkeTrongKhoang",
                data: { ngaybatdau: startDateInput.value, ngayketthuc: endDateInput.value },
                success: function (result) {
                    updateChartData(result, numberOfDays, startDateInput);
                    console.log(result);
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }

        function calculateNumberOfDays(startDate, endDate) {
            // Tính số ngày giữa hai ngày
            const start = new Date(startDate);
            const end = new Date(endDate);
            const timeDiff = Math.abs(end - start);
            const numberOfDays = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

            return numberOfDays;
        }

        let myChart = null;

        function updateChartData(data, numberOfDays, startDateInput) {
            const ctx = document.getElementById('myChartj');
            if (myChart) {
                myChart.destroy();
            }

            let labels = [];

            if (numberOfDays <= 31) {
                // Nếu số ngày ít hơn hoặc bằng 31, hiển thị theo ngày
                const startDate = new Date(startDateInput.value);
                labels = Array.from({ length: numberOfDays }, (_, i) => {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);
                    return formatDateNoYear(date); // Use a function without year
                });
            } else {
                // Nếu số ngày lớn hơn 31, hiển thị theo tháng
                const startMonth = new Date(startDateInput.value).getMonth();
                for (let i = 0; i < numberOfDays / 30; i++) {
                    labels.push(`Tháng ${startMonth + i + 1}`);
                }
            }

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '#Hóa đơn',
                        data: data, // Giả sử 'data' là một mảng điểm dữ liệu tương ứng trong kết quả
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Add a new function to format the date without the year
        function formatDateNoYear(date) {
            const options = { month: 'numeric', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

    });

</script>



